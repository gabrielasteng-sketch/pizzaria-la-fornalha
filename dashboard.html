<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Pedidos - La Fornalha</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f1f5f9; /* bg-slate-100 */
        }
        .status-novo { background-color: #3b82f6; color: white; }
        .status-em-preparo { background-color: #f59e0b; color: white; }
        .status-pronto-para-entrega { background-color: #10b981; color: white; }
        .status-finalizado { background-color: #6b7280; color: white; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="mb-8">
        <h1 class="text-4xl font-bold text-slate-800">Painel de Pedidos</h1>
        <p class="text-slate-600">Visualize e gerencie os pedidos recebidos em tempo real.</p>
    </header>

    <main id="orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        <!-- Os cards de pedido serão inseridos aqui pelo JavaScript -->
        <div id="loading" class="col-span-full text-center p-10">
            <p class="text-slate-500 text-lg">Aguardando novos pedidos...</p>
        </div>
    </main>

    <!-- Elemento de áudio para notificação de novo pedido -->
    <audio id="notification-sound" src="https://assets.mixkit.co/sfx/preview/mixkit-correct-answer-tone-2870.mp3" preload="auto"></audio>

    <script>
        const API_URL = 'https://pizzaria-backend-gw0s.onrender.com';
        const ordersGrid = document.getElementById('orders-grid');
        const loadingMessage = document.getElementById('loading');
        const notificationSound = document.getElementById('notification-sound');
        let knownOrderIds = new Set();

        // Função para buscar os pedidos no back-end
        async function fetchOrders() {
            try {
                const response = await fetch(`${API_URL}/admin/orders`);
                if (!response.ok) throw new Error('Falha ao buscar pedidos');
                
                const orders = await response.json();
                renderOrders(orders);

            } catch (error) {
                console.error("Erro:", error);
                loadingMessage.innerHTML = `<p class="text-red-500 text-lg">Erro ao conectar com o servidor. Verifique se ele está rodando.</p>`;
            }
        }

        // Função para renderizar os pedidos na tela
        function renderOrders(orders) {
            if (orders.length === 0) {
                loadingMessage.style.display = 'block';
                ordersGrid.innerHTML = ''; // Limpa a grade se não houver pedidos
                ordersGrid.appendChild(loadingMessage);
                return;
            }
            
            loadingMessage.style.display = 'none';
            ordersGrid.innerHTML = ''; // Limpa a grade antes de renderizar

            orders.forEach(order => {
                // Toca o som se for um pedido novo
                if (!knownOrderIds.has(order.id)) {
                    notificationSound.play();
                    knownOrderIds.add(order.id);
                }

                const orderCard = document.createElement('div');
                orderCard.className = 'bg-white rounded-lg shadow-md p-6 flex flex-col gap-4';
                
                const statusClass = `status-${order.status.toLowerCase().replace(/ /g, '-')}`;

                orderCard.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold text-slate-900">Pedido #${order.id}</h2>
                            <p class="text-sm text-slate-500">Recebido às: ${order.receivedAt}</p>
                        </div>
                        <span class="px-3 py-1 text-sm font-semibold rounded-full ${statusClass}">${order.status}</span>
                    </div>
                    
                    <div class="border-t border-b border-slate-200 py-3">
                        <ul class="space-y-1 text-slate-700">
                            ${order.items.map(item => `
                                <li class="flex justify-between">
                                    <span>${item.quantity}x ${item.name}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>

                    <div class="text-right">
                        <p class="text-lg font-bold text-slate-800">Total: R$ ${order.total.toFixed(2).replace('.', ',')}</p>
                    </div>

                    <div class="mt-auto pt-4 flex flex-col gap-2">
                        ${order.status === 'Novo' ? `<button onclick="updateStatus(${order.id}, 'Em preparo')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Aceitar Pedido</button>` : ''}
                        ${order.status === 'Em preparo' ? `<button onclick="updateStatus(${order.id}, 'Pronto para entrega')" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-2 px-4 rounded-lg w-full">Pronto para Entrega</button>` : ''}
                        ${order.status === 'Pronto para entrega' ? `<button onclick="updateStatus(${order.id}, 'Finalizado')" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg w-full">Finalizar Pedido</button>` : ''}
                    </div>
                `;
                ordersGrid.appendChild(orderCard);
            });
        }

        // Função para atualizar o status de um pedido
        async function updateStatus(orderId, newStatus) {
            try {
                await fetch(`${API_URL}/admin/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newStatus })
                });
                fetchOrders(); // Atualiza a tela após a mudança de status
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
                alert('Não foi possível atualizar o status do pedido.');
            }
        }

        // Inicia o sistema: busca os pedidos imediatamente e depois a cada 5 segundos
        fetchOrders();
        setInterval(fetchOrders, 5000); // Atualiza a cada 5 segundos
    </script>
</body>
</html>

